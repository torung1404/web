<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ToRungHub Live Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #02010a 100%);
      color: #f9fafb;
    }
    a { color: #60a5fa; text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      padding: 12px 20px;
      background: #020617ee;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #1f2933;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: conic-gradient(from 180deg, #22c55e, #0ea5e9, #6366f1, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px rgba(96,165,250,0.8);
    }
    .brand-logo span {
      font-size: 16px;
      font-weight: 800;
      color: #020617;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header small {
      color: #9ca3af;
      font-size: 11px;
      display: block;
    }
    nav {
      display: flex;
      gap: 10px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    nav a {
      padding: 4px 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #111827;
      color: #e5e7eb;
    }
    nav a:hover {
      background: #0f172a;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #0f172a;
      color: #e5e7eb;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fbbf24;
    }
    .status-dot.green { background: #22c55e; }
    .status-dot.red { background: #f97373; }
    .status-dot.gray { background: #6b7280; }

    main {
      padding: 16px 20px 24px;
      max-width: 1300px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 2.3fr 1.1fr;
      gap: 16px;
    }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #111827;
      box-shadow: 0 20px 40px rgba(15,23,42,0.7);
      padding: 12px 14px 14px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card-header h2 {
      margin: 0;
      font-size: 15px;
    }
    .card-header small {
      color: #9ca3af;
      font-size: 11px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .controls input[type="text"],
    .controls input[type="number"] {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      font-size: 12px;
      min-width: 170px;
    }
    .controls label {
      font-size: 11px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .controls input[type="checkbox"] {
      accent-color: #22c55e;
    }
    button { font-family: inherit; }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid transparent;
      font-size: 12px;
      cursor: pointer;
      background: #1d4ed8;
      color: #f9fafb;
      transition: background 0.15s ease, transform 0.05s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    .btn.secondary {
      background: #020617;
      border-color: #374151;
      color: #e5e7eb;
    }
    .btn.secondary:hover { background: #111827; }
    .btn.danger { background: #b91c1c; }
    .btn.danger:hover { background: #ef4444; }
    .btn-xs {
      padding: 3px 7px;
      font-size: 11px;
      border-radius: 999px;
    }
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .stats-pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #111827;
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: #0b1120; }
    th, td {
      padding: 6px 8px;
      font-size: 12px;
      border-bottom: 1px solid #111827;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-weight: 600;
      color: #e5e7eb;
      white-space: nowrap;
    }
    tbody tr:nth-child(even),
    tbody tr:nth-child(odd) { background: #020617; }
    tbody tr:hover { background: #111827; }
    td small { color: #9ca3af; font-size: 11px; }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #0f172a;
      color: #e5e7eb;
      white-space: nowrap;
    }
    .badge.green { background: #064e3b; color: #a7f3d0; }
    .badge.yellow { background: #92400e; color: #facc15; }
    .badge.purple { background: #4c1d95; color: #ddd6fe; }
    .badge.gray { background: #111827; color: #9ca3af; }

    .details {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 260px;
      overflow: auto;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #111827;
      padding: 6px 8px;
    }
    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 6px;
    }
    .details-header span { font-size: 11px; color: #9ca3af; }

    .quick-section { margin-top: 10px; font-size: 12px; }
    .quick-section h3 { margin: 0 0 6px; font-size: 13px; }
    .snippet {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #111827;
      padding: 6px 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    .snippet code {
      color: #e5e7eb;
      white-space: nowrap;
      overflow-x: auto;
    }
    .snippet button { flex-shrink: 0; }
    .small-muted { font-size: 11px; color: #9ca3af; }

    @media (max-width: 720px) {
      main { padding: 10px 10px 16px; }
      .card { padding: 10px; }
      header { padding: 8px 10px; }
      .snippet code { white-space: normal; }
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-logo"><span>T</span></div>
    <div>
      <h1>ToRungHub Live Viewer</h1>
      <small>Real-time Roblox workspace scanner (mobs / chests / jobId / placeId)</small>
    </div>
  </div>
  <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
    <nav>
      <a href="https://github.com/torung1404/ToRungHub" target="_blank">GitHub</a>
      <a href="https://discord.com/app" target="_blank">Discord</a>
      <a href="#help">Help</a>
    </nav>
    <span id="statusBadge" class="status-badge">
      <span id="statusDot" class="status-dot"></span>
      <span id="statusText">WS: connecting…</span>
    </span>
  </div>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <div class="card-header">
      <div>
        <h2>Active servers / sessions</h2>
        <small>List of all <code>pets_update</code> packets sent from Roblox scripts.</small>
      </div>
      <button id="btnReconnect" class="btn secondary">Reconnect WS</button>
    </div>

    <div class="controls">
      <input id="searchInput" type="text" placeholder="Search player / jobId / place / text..." />
      <input id="filterPlaceInput" type="text" placeholder="Filter by placeId (optional)" />
      <label>
        Min lines:
        <input id="minLinesInput" type="number" min="0" value="0" style="width:70px;" />
      </label>
      <label>
        <input id="pinnedOnlyInput" type="checkbox" />
        Pinned only
      </label>
      <button id="btnClear" class="btn secondary">Clear All</button>
    </div>

    <div class="stats-row">
      <span class="stats-pill" id="statsSessions">0 sessions</span>
      <span class="stats-pill" id="statsPlayers">0 players</span>
      <span class="stats-pill" id="statsPlaces">0 places</span>
      <span class="stats-pill" id="statsLastUpdate">last update: —</span>
    </div>

    <div style="overflow-x:auto; border-radius:8px;">
      <table>
        <thead>
        <tr>
          <th>Player</th>
          <th>Place / Job</th>
          <th>Lines</th>
          <th>Age</th>
          <th>Tags</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- RIGHT -->
  <aside>
    <section class="card" style="margin-bottom:12px;">
      <div class="card-header">
        <div>
          <h2>Details</h2>
          <small>Full mob/chest list of selected session.</small>
        </div>
        <span id="detailsMeta" class="small-muted">No session selected.</span>
      </div>
      <div id="detailsBox" class="details" style="display:none;"></div>
      <div class="small-muted" id="detailsHint">Click “View” on any row to see full content.</div>
    </section>

    <section class="card" id="help">
      <div class="card-header">
        <div>
          <h2>Quick snippets & links</h2>
          <small>Copy-paste blocks for Roblox / sharing ToRungHub.</small>
        </div>
      </div>
      <div class="quick-section">
        <h3>Load ToRungHub (full)</h3>
        <div class="snippet">
          <code id="snippetFull">loadstring(game:HttpGet("https://raw.githubusercontent.com/torung1404/ToRungHub/main/loader.lua"))()</code>
          <button class="btn btn-xs secondary" data-copy="snippetFull">Copy</button>
        </div>

        <h3>Load WS scanner + sender</h3>
        <div class="snippet">
          <code id="snippetSender">loadstring(game:HttpGet("https://raw.githubusercontent.com/torung1404/ToRungHub/main/WorkspaceSender.lua"))()</code>
          <button class="btn btn-xs secondary" data-copy="snippetSender">Copy</button>
        </div>

        <h3>Current WebSocket URL</h3>
        <div class="snippet">
          <code id="snippetWsUrl"></code>
          <button class="btn btn-xs secondary" data-copy="snippetWsUrl">Copy</button>
        </div>

        <p class="small-muted">
          Tip: Share this page + loadstring to teammates. Họ gửi server info lên đây,
          bạn chỉ cần copy <code>TeleportToPlaceInstance</code> để nhảy server.
        </p>
      </div>
    </section>
  </aside>
</main>

<script>
  // ===== BASIC CONFIG =====
  var origin = window.location.origin;
  var defaultWsUrl = origin.replace(/^http/, "ws");

  // DOM refs
  var statusDot      = document.getElementById("statusDot");
  var statusText     = document.getElementById("statusText");
  var btnReconnect   = document.getElementById("btnReconnect");
  var btnClear       = document.getElementById("btnClear");
  var searchInput    = document.getElementById("searchInput");
  var filterPlaceInput = document.getElementById("filterPlaceInput");
  var minLinesInput  = document.getElementById("minLinesInput");
  var pinnedOnlyInput= document.getElementById("pinnedOnlyInput");
  var tableBody      = document.getElementById("tableBody");

  var statsSessions  = document.getElementById("statsSessions");
  var statsPlayers   = document.getElementById("statsPlayers");
  var statsPlaces    = document.getElementById("statsPlaces");
  var statsLastUpdate= document.getElementById("statsLastUpdate");

  var detailsBox     = document.getElementById("detailsBox");
  var detailsMeta    = document.getElementById("detailsMeta");
  var detailsHint    = document.getElementById("detailsHint");

  var snippetWsUrl   = document.getElementById("snippetWsUrl");
  snippetWsUrl.textContent = defaultWsUrl;

  // Copy buttons
  var copyButtons = document.querySelectorAll("[data-copy]");
  for (var i = 0; i < copyButtons.length; i++) {
    (function(btn){
      btn.addEventListener("click", function () {
        var id = btn.getAttribute("data-copy");
        var el = document.getElementById(id);
        if (!el) return;
        var txt = el.textContent || "";
        navigator.clipboard.writeText(txt).then(function () {
          var old = btn.textContent;
          btn.textContent = "Copied";
          setTimeout(function(){ btn.textContent = old; }, 800);
        }).catch(function(){});
      });
    })(copyButtons[i]);
  }

  // ===== DATA MODEL =====
  var records = {}; // key -> record
  var socket = null;
  var lastUpdateTs = null;
  var currentDetailsKey = null;

  function setStatus(state, label) {
    statusText.textContent = "WS: " + label;
    var cls = "status-dot gray";
    if (state === "connected") cls = "status-dot green";
    else if (state === "error" || state === "closed") cls = "status-dot red";
    statusDot.className = cls;
  }

  function formatRelative(ts) {
    if (!ts) return "—";
    var diff = Date.now() - ts;
    var s = Math.floor(diff / 1000);
    if (s < 60) return s + "s ago";
    var m = Math.floor(s / 60);
    if (m < 60) return m + "m ago";
    var h = Math.floor(m / 60);
    return h + "h ago";
  }

  function connectWs() {
    if (socket) {
      try { socket.close(); } catch(e) {}
      socket = null;
    }
    var url = defaultWsUrl;
    console.log("[Viewer] Connecting to", url);
    setStatus("connecting", "connecting…");

    try {
      socket = new WebSocket(url);
    } catch (e) {
      console.error("[Viewer] Failed to create WebSocket:", e);
      setStatus("error", "create failed");
      return;
    }

    socket.onopen = function () {
      console.log("[Viewer] WebSocket open");
      setStatus("connected", "connected");
    };

    socket.onclose = function () {
      console.log("[Viewer] WebSocket closed");
      setStatus("closed", "closed");
    };

    socket.onerror = function (err) {
      console.error("[Viewer] WebSocket error:", err);
      setStatus("error", "error");
    };

    socket.onmessage = function (event) {
      var data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        console.error("[Viewer] parse error", e, event.data);
        return;
      }
      if (data && data.type === "pets_update") {
        handlePetsUpdate(data);
      }
    };
  }

  function handlePetsUpdate(msg) {
    var key = String(msg.jobId || "unknown") + "|" + String(msg.player || "Unknown");
    var ts = msg.ts || Date.now();
    var existing = records[key];

    if (existing && existing.ts && ts <= existing.ts) {
      return; // ignore old packet
    }

    var pets = Array.isArray(msg.pets) ? msg.pets : [];
    var searchBlob = (String(msg.player) + " " + String(msg.placeId) + " " +
                      String(msg.jobId) + " " + pets.join(" ")).toLowerCase();

    records[key] = {
      key: key,
      player: msg.player || "Unknown",
      placeId: msg.placeId || 0,
      jobId: msg.jobId || "unknown",
      pets: pets,
      ts: ts,
      pinned: existing ? !!existing.pinned : false,
      searchBlob: searchBlob
    };

    lastUpdateTs = Date.now();
    renderTable();
    if (currentDetailsKey === key) showDetails(key);
  }

  function renderTable() {
    var q = (searchInput.value || "").toLowerCase();
    var placeFilter = (filterPlaceInput.value || "").trim();
    var minLines = parseInt(minLinesInput.value || "0", 10) || 0;
    var pinnedOnly = pinnedOnlyInput.checked;

    tableBody.innerHTML = "";

    var arr = [];
    for (var k in records) arr.push(records[k]);
    arr.sort(function(a,b){ return (b.ts || 0) - (a.ts || 0); });

    var seenPlayers = {};
    var seenPlaces  = {};
    var visible = 0;

    for (var i = 0; i < arr.length; i++) {
      var rec = arr[i];
      seenPlayers[rec.player] = true;
      seenPlaces[String(rec.placeId)] = true;

      if (pinnedOnly && !rec.pinned) continue;
      if (rec.pets.length < minLines) continue;
      if (placeFilter && String(rec.placeId) !== placeFilter) continue;
      if (q && rec.searchBlob.indexOf(q) === -1) continue;

      visible++;

      var tr = document.createElement("tr");

      var tdPlayer = document.createElement("td");
      tdPlayer.innerHTML = "<strong>" + rec.player + "</strong>" +
        (rec.pinned ? ' <span class="badge yellow">PINNED</span>' : "");
      tr.appendChild(tdPlayer);

      var tdJob = document.createElement("td");
      tdJob.innerHTML =
        "Place: <code>" + rec.placeId + "</code><br>Job: <code>" + rec.jobId + "</code>";
      tr.appendChild(tdJob);

      var tdLines = document.createElement("td");
      tdLines.innerHTML = '<span class="badge purple">' + rec.pets.length + "</span>";
      tr.appendChild(tdLines);

      var tdAge = document.createElement("td");
      tdAge.innerHTML = "<small>" + formatRelative(rec.ts) + "</small>";
      tr.appendChild(tdAge);

      var tdTags = document.createElement("td");
      var tagHtml;
      if (rec.pets.length === 0) {
        tagHtml = '<span class="badge gray">empty</span>';
      } else if (rec.pets.length > 100) {
        tagHtml = '<span class="badge yellow">HUGE</span>';
      } else {
        tagHtml = '<span class="badge green">OK</span>';
      }
      tdTags.innerHTML = tagHtml;
      tr.appendChild(tdTags);

      var tdActions = document.createElement("td");

      var btnView = document.createElement("button");
      btnView.className = "btn btn-xs secondary";
      btnView.textContent = "View";
      btnView.onclick = (function(key){ return function(){ showDetails(key); }; })(rec.key);

      var btnTp = document.createElement("button");
      btnTp.className = "btn btn-xs secondary";
      btnTp.textContent = "Copy TP";
      btnTp.onclick = (function(rec){
        return function(){
          var snippet = 'game:GetService("TeleportService"):TeleportToPlaceInstance(' +
                        rec.placeId + ', "' + rec.jobId + '", game.Players.LocalPlayer)';
          navigator.clipboard.writeText(snippet).then(function(){
            var old = btnTp.textContent;
            btnTp.textContent = "Copied";
            setTimeout(function(){ btnTp.textContent = old; }, 800);
          }).catch(function(){});
        };
      })(rec);

      var btnTxt = document.createElement("button");
      btnTxt.className = "btn btn-xs secondary";
      btnTxt.textContent = "Copy text";
      btnTxt.onclick = (function(rec){
        return function(){
          navigator.clipboard.writeText((rec.pets || []).join("\n")).then(function(){
            var old = btnTxt.textContent;
            btnTxt.textContent = "Copied";
            setTimeout(function(){ btnTxt.textContent = old; }, 800);
          }).catch(function(){});
        };
      })(rec);

      var btnJson = document.createElement("button");
      btnJson.className = "btn btn-xs secondary";
      btnJson.textContent = "Copy JSON";
      btnJson.onclick = (function(rec){
        return function(){
          var payload = JSON.stringify({
            type: "pets_update",
            player: rec.player,
            placeId: rec.placeId,
            jobId: rec.jobId,
            pets: rec.pets,
            ts: rec.ts
          }, null, 2);
          navigator.clipboard.writeText(payload).then(function(){
            var old = btnJson.textContent;
            btnJson.textContent = "Copied";
            setTimeout(function(){ btnJson.textContent = old; }, 800);
          }).catch(function(){});
        };
      })(rec);

      var btnPin = document.createElement("button");
      btnPin.className = "btn btn-xs secondary";
      btnPin.textContent = rec.pinned ? "Unpin" : "Pin";
      btnPin.onclick = (function(rec){
        return function(){
          rec.pinned = !rec.pinned;
          records[rec.key] = rec;
          renderTable();
        };
      })(rec);

      tdActions.appendChild(btnView);
      tdActions.appendChild(btnTp);
      tdActions.appendChild(btnTxt);
      tdActions.appendChild(btnJson);
      tdActions.appendChild(btnPin);
      tr.appendChild(tdActions);

      tableBody.appendChild(tr);
    }

    // Stats
    var playersCount = 0;
    for (var p in seenPlayers) playersCount++;
    var placesCount  = 0;
    for (var pl in seenPlaces) placesCount++;

    var totalSessions = 0;
    for (var kk in records) totalSessions++;

    statsSessions.textContent   = totalSessions + " sessions";
    statsPlayers.textContent    = playersCount + " players";
    statsPlaces.textContent     = placesCount + " places";
    statsLastUpdate.textContent = "last update: " +
      (lastUpdateTs ? new Date(lastUpdateTs).toLocaleTimeString() : "—");
  }

  function showDetails(key) {
    var rec = records[key];
    if (!rec) return;
    currentDetailsKey = key;
    var timeStr = new Date(rec.ts).toLocaleString();
    detailsMeta.textContent = rec.player +
      " • placeId=" + rec.placeId +
      " • jobId=" + rec.jobId +
      " • lines=" + rec.pets.length +
      " • " + timeStr;
    detailsBox.textContent = (rec.pets || []).join("\n");
    detailsBox.style.display = "block";
    detailsHint.style.display = "none";
  }

  function clearAll() {
    records = {};
    currentDetailsKey = null;
    detailsBox.style.display = "none";
    detailsBox.textContent = "";
    detailsMeta.textContent = "No session selected.";
    detailsHint.style.display = "block";
    renderTable();
  }

  // Events
  btnReconnect.addEventListener("click", connectWs);
  btnClear.addEventListener("click", clearAll);
  searchInput.addEventListener("input", renderTable);
  filterPlaceInput.addEventListener("input", renderTable);
  minLinesInput.addEventListener("input", renderTable);
  pinnedOnlyInput.addEventListener("change", renderTable);

  // Start
  setStatus("connecting", "connecting…");
  connectWs();
</script>
</body>
</html>
